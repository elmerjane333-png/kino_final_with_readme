{% extends "base.html" %}
{% block content %}
<section class="admin-panel">
  <h2>Admin Dashboard (secret)</h2>
  <p class="muted">Secret path: <code>/{{ secret_path }}</code></p>
  <div id="live-area">
    <h3>Live submissions</h3>
    <div id="submissions-list" style="display:flex;flex-direction:column;gap:10px"></div>
  </div>
  <hr/>
  <h3>All submissions (history)</h3>
  <table class="nice-table">
    <thead><tr><th>ID</th><th>Kind</th><th>Payload</th><th>Time</th></tr></thead>
    <tbody>
      {% for s in subs %}
      <tr>
        <td>{{ s.id }}</td>
        <td>{{ s.kind }}</td>
        <td style="white-space:pre-wrap">{{ s.payload }}</td>
        <td>{{ s.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</section>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
  (function() {
    const socket = io('/', { path: '/socket.io' });
    socket.on('connect', () => { console.log('socket connected', socket.id); socket.emit('join', {}); });
    socket.on('joined', function(d){ console.log('joined admin namespace', d); });
    socket.on('new_submission', function(data){
      const box = document.getElementById('submissions-list');
      const entry = document.createElement('div');
      entry.className = 'card';
      entry.style.padding = '10px'; entry.style.borderRadius = '8px'; entry.style.background = '#ffffff'; entry.style.boxShadow = '0 8px 20px rgba(0,0,0,0.04)';
      entry.innerHTML = `<div style="font-weight:700">[${data.kind}] from user ${data.user_id || 'unknown'} â€” <small>${new Date(data.created_at).toLocaleString()}</small></div>
                         <pre style="white-space:pre-wrap;margin-top:8px;background:#f6f6f6;padding:8px;border-radius:6px">${JSON.stringify(data.payload, null, 2)}</pre>`;
      if(box.firstChild) box.insertBefore(entry, box.firstChild); else box.appendChild(entry);
    });
  })();
</script>
{% endblock %}
